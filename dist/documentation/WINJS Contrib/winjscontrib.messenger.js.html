<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>WinJS Contrib Source: winjscontrib.messenger.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cosmo.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">WinJS Contrib</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="global.html#WinJSContrib">WinJSContrib</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Alerts.html">Alerts</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Bindings.html">Bindings</a>
						</li>
						
						<li>
							<a href="WinJSContrib.CrossPlatform.html">CrossPlatform</a>
						</li>
						
						<li>
							<a href="WinJSContrib.CrossPlatform.isMobile.html">isMobile</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Logging.html">Logging</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Logging.Appenders.html">Appenders</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Search.html">Search</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Templates.html">Templates</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.html">UI</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.Animation.html">Animation</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.DataForm.Converters.html">Converters</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.DataForm.defaultBindingOptions.html">defaultBindingOptions</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.DataSources.html">DataSources</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.DataSources.Grouping.html">Grouping</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.WebComponents.html">WebComponents</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Utils.html">Utils</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Utils.ValueParsers.html">ValueParsers</a>
						</li>
						
						<li>
							<a href="WinJSContrib.WinRT.html">WinRT</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="WinJSContrib.Logging.Appenders.ConsoleAppender.html">ConsoleAppender</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Logging.LoggerClass.html">LoggerClass</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Messenger.html">Messenger</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Messenger.SmartWorker.html">SmartWorker</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Search.Index.html">Index</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Search.IndexGroup.html">IndexGroup</a>
						</li>
						
						<li>
							<a href="WinJSContrib.Search.Stemming.Pipeline.html">Pipeline</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.ChildViewFlyout.html">ChildViewFlyout</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.DataForm.html">DataForm</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.DataSources.DataSourceManager.html">DataSourceManager</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.ElasticInput.html">ElasticInput</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.EventTracker.html">EventTracker</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.ExtendedSplash.html">ExtendedSplash</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.FlipSnap.html">FlipSnap</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.FlipViewPager.html">FlipViewPager</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.FluentDOM.html">FluentDOM</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.FlyoutPage.html">FlyoutPage</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.GlobalProgress.html">GlobalProgress</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.GridControl.html">GridControl</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.HubControl.html">HubControl</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.MediaTrigger.html">MediaTrigger</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.MultiPassItem.html">MultiPassItem</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.MultiPassRenderer.html">MultiPassRenderer</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.PageControlNavigator.html">PageControlNavigator</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.SemanticListViews.html">SemanticListViews</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UI.SmartListLayout.html">SmartListLayout</a>
						</li>
						
						<li>
							<a href="WinJSContrib.UPnP.UPnPDevice.html">UPnPDevice</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: winjscontrib.messenger.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">/* 
 * WinJS Contrib v2.1.0.2
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

var WinJSContrib = WinJSContrib || {};

(function () {

    function Messenger(receiver, sender) {
        var messenger = this;
        messenger.isWorker = receiver.document === undefined;
        messenger._pendings = {};
        messenger._receiver = receiver;
        messenger._sender = sender || receiver;
        messenger._bindedProcessEvent = messenger._processEvent.bind(messenger);

        if (messenger._receiver)
            messenger._receiver.addEventListener('message', messenger._bindedProcessEvent);
    };

    /**
     * @classdesc
     * Wrapper for messaging between main code and iframe or web worker. All returns are wrapped as WinJS.Promise to enable asynchronous scenarios     
     * @class
     * @param {DOMElement} receiver element that will receive messages
     * @param {DOMElement} sender element that will send messages
     */
    WinJSContrib.Messenger = WinJS.Class.mix(Messenger, WinJS.Utilities.eventMixin);

    /**
     * default path for smart worker js file
     */
    WinJSContrib.Messenger.SmartWorkerPath = '/scripts/winjscontrib/winjscontrib.messenger.worker.js';

    /**
     * @classdesc
     * Wrapper for {@link WinJSContrib.Messenger} when using it with a webworker
     * @class
     * @param {string} [path] path to web worker file
     */
    WinJSContrib.Messenger.SmartWorker = function (path) {
        if (window.Worker) {
            var w = new window.Worker(path || WinJSContrib.Messenger.SmartWorkerPath);
            return new WinJSContrib.Messenger(w, w);
        }

        return new WinJSContrib.Messenger(null, null);
    }


    WinJSContrib.Messenger.prototype._send = function (obj) {
        if (this.isWorker) {
            this._sender.postMessage(JSON.stringify(obj));
        }
        else {
            this._sender.postMessage(JSON.stringify(obj), '*');
        }
    };

    /**
     * import script files
     * @param {Array} scriptPaths an array of string paths to js files
     */
    WinJSContrib.Messenger.prototype.importScripts = function (scriptPaths) {
        if (!this._receiver)
            return WinJS.Promise.wrap();

        return this.start('_doImportScripts', scriptPaths);
    }

    WinJSContrib.Messenger.prototype._doImportScripts = function (scriptPaths) {
        return new WinJS.Promise(function (c) {
            if (typeof scriptPaths == 'string') {
                importScripts(scriptPaths);
            } else if (scriptPaths.length) {
                for (var i = 0 ; i &lt; scriptPaths.length ; i++) {
                    importScripts(scriptPaths[i]);
                }
            }
            c();
        });
    }

    /**
     * run the callback in the web worker. The callback is serialized to string so you must pass all variable used inside the function as arguments
     * @param {function} func function callback
     * @param {...Object} args
     * @returns {WinJS.Promise}
     */
    WinJSContrib.Messenger.prototype.execute = function (func) {
        var messenger = this;
        var args = [];
        if (arguments.length > 1) {
            for (var i = 1 ; i &lt; arguments.length; i++) {
                args.push(arguments[i]);
            }
        }

        if (messenger._receiver) {
            var f = 'var messengerFunction=' + func;

            return this.start('_runFunction', { f: f, args: args });
        }
        else {
            return WinJS.Promise.timeout(0).then(function () {
                return func.apply(null, args);
            });
        }
    }

    WinJSContrib.Messenger.prototype._runFunction = function (functionArgs) {
        var messenger = this;
        return new WinJS.Promise(function (c, e) {
            try {
                eval(functionArgs.f);
                var res = messengerFunction.apply(null, functionArgs.args);
                c(res);
            } catch (exception) {
                e(exception);
            }
        });
    }

    WinJSContrib.Messenger.prototype.map = function (object, functions) {
        var messenger = this;
        functions.forEach(function (name) {
            messenger[name] = function () {
                var f = object[name];
                return f.apply(object, arguments);
            }
        });
    }

    /**
     * start an operation within iframe or worker and get a promise for completion
     * @param {string} eventName name of the event/function to call
     * @param {Object} data event/function passed as argument
     * @returns {WinJS.Promise}
     */
    WinJSContrib.Messenger.prototype.start = function (eventName, data, asArgs) {
        var messenger = this;

        if (!messenger._receiver)
            return WinJS.Promise.wrapError('worker not supported');

        var wrapper = {
            id: WinJSContrib.Utils.guid(),
            complete: null, error: null, progress: null, promise: null
        }

        var event = {
            name: eventName,
            id: wrapper.id,
            type: 'run',
            data: data,
            asArgs: asArgs,
            sender: 'WinJSContrib.WinJSContrib.Messenger'
        };

        wrapper.promise = new WinJS.Promise(function (c, e, p) {
            wrapper.complete = c;
            wrapper.error = e;
            wrapper.progress = p;
        }, function oncancel() {
            console.warn('message canceled');
            event.type = 'cancel';
            messenger._send(event);
        });

        messenger._pendings[wrapper.id] = wrapper;
        var cleanUp = function () {
            delete messenger._pendings[wrapper.id];
        }
        wrapper.promise.done(cleanUp, cleanUp);
        messenger._send(event);

        return wrapper.promise;
    };

    WinJSContrib.Messenger.prototype._processEvent = function (arg) {
        var messenger = this;
       
        var details = typeof (arg.data) == 'string' ? JSON.parse(arg.data) : arg.data;
        var name = details.name;
        var data = details.data;
        var asArgs = details.asArgs;

        if (details.id) {
            var wrapper = messenger._pendings[details.id];
            if (wrapper &amp;&amp; wrapper[details.type]) {
                wrapper[details.type](data);
                return;
            }

            if (details.type === 'cancel') {
                var current = messenger._pendings[details.id];
                if (current) {
                    current.promise.cancel();
                    delete messenger._pendings[details.id];
                }
            }
            else if (details.type==='run' &amp;&amp; name &amp;&amp; messenger[name]) {
                try {
                    var p = null;
                    if (asArgs) {
                        p = WinJS.Promise.as(messenger[name].apply(messenger[name], data));
                    } else {
                        p = WinJS.Promise.as(messenger[name](data));
                    }

                   messenger._pendings[details.id] = { promise: p, details: details };

                    p.then(function (arg) {
                        messenger._send({ name: name, id: details.id, type: 'complete', sender: 'WinJSContrib.WinJSContrib.Messenger', data: arg });
                    }, function (arg) {
                        messenger._send({ name: name, id: details.id, type: 'error', sender: 'WinJSContrib.WinJSContrib.Messenger', data: arg });
                    }, function (arg) {
                        messenger._send({ name: name, id: details.id, type: 'progress', sender: 'WinJSContrib.WinJSContrib.Messenger', data: arg });
                    }).then(function () {
                        delete messenger._pendings[details.id];
                    });
                } catch (exception) {
                    delete messenger._pendings[details.id];
                    messenger._send({ name: name, id: details.id, type: 'error', sender: 'WinJSContrib.WinJSContrib.Messenger', data: { description: exception.description, message: exception.message, stack: exception.stack } });
                }

                return;
            }
            else {
                messenger._send({ name: name, id: details.id, type: 'error', sender: 'WinJSContrib.WinJSContrib.Messenger', data: { message: 'callback function not found' } });
            }
        } else {
            if (name &amp;&amp; messenger[name]) {
                messenger[name](data);
                return;
            }
            messenger.dispatchEvent(name, data);
        }
    };

    /**
     * release messenger and associated resources (if using webworker, worker is terminated
     */
    WinJSContrib.Messenger.prototype.dispose = function () {
        var messenger = this;
        if (messenger._receiver) {
            if (messenger._receiver.terminate)
                messenger._receiver.terminate();

            messenger._receiver.removeEventListener('message', messenger._bindedProcessEvent);
        }
    };
})();</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					by MCNEXT
					<br />
					
					
		<span class="copyright">
		copyright MCNEXT
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a>
		on Thu Jul 16 2015 17:20:42 GMT+0200 (Romance Daylight Time) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
