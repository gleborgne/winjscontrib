/* 
 * WinJS Contrib v2.1.0.4
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

var WinJSContrib=WinJSContrib||{};WinJSContrib.BgDownloads=WinJSContrib.BgDownloads||{},function(){"use strict";var e=Windows.Storage.ApplicationData.current.localFolder,n="downloadeditems.json",t=WinJS.Binding.define({download:null,status:null,progress:0}),o=WinJSContrib.Logs.getLogger("WinJSContrib.BgDownloadTracker"),r={waiting:"waiting",downloading:"downloading",downloaded:"downloaded",error:"error",completed:"completed"},i=WinJS.Binding.define({nbPendings:0});WinJSContrib.BgDownloads.Tracker=WinJS.Class.mix(WinJS.Class.define(function(e,n){var t=this;t.name=e,n=n||{},t.state=new i,this.tempExtension=".download",this.saveItemsPromise=WinJS.Promise.wrap(),this.downloadsStart=WinJS.Promise.wrap(),this.folder=n.folder,this.retryOnError=n.retryOnError,this.handleItemProperties=n.handleItemProperties,this.maxConcurrentDownloads=n.maxConcurrentDownloads||300,this.debouncedCheck=_.debounce(function(){t.checkDownloads()},200,!1),this.debouncedVerif=_.debounce(function(){t.verifyItems()},200,!1),this.debouncedSave=_.throttle(function(){t.saveItems()},200,!1),n.getFolder&&(this.getFolder=n.getFolder),n.createFolder&&(this.createFolder=n.createFolder),this.items=new WinJS.Binding.List,this.defaultFolderPromise=t._getFolder(!0),this.refreshInterval=null,t.ready=!1},{_getFolder:function(e){return this.folder?WinJS.Promise.wrap(this.folder):e?this.createFolder():this.getFolder()},getFolder:function(){return e.getFolderAsync("bgdownloads\\"+this.name,Windows.Storage.CreationCollisionOption.openIfExists)},createFolder:function(n){return e.createFolderAsync("bgdownloads\\"+this.name,Windows.Storage.CreationCollisionOption.openIfExists)},_loadItemsFile:function(){var e=this;return e._getFolder(!1).then(function(e){return e?e.getFileAsync(n).then(function(e){return Windows.Storage.FileIO.readTextAsync(e).then(function(e){var n=e?JSON.parse(e):{};return n})}):void 0},function(e){return o.error("internal error loading items",e),[]})},verifyItems:function(){var e=this,n=[];return e.items.length?(e.items.forEach(function(t){n.push(t.status==r.downloading&&t.downloadid&&!t.download?e._swapTempFile(t).then(function(){return e._checkItem(t)}):e._checkItem(t))}),WinJS.Promise.join(n).then(function(){return e.saveItems()}).then(function(){e.debouncedCheck()})):WinJS.Promise.wrap()},startLoop:function(){var e=this;e.refreshInterval||(e.items.length>0||WinJSContrib.BgDownloads.currentDownloads.length>0)&&(e.refreshInterval=setInterval(function(){e.debouncedCheck()},6e4))},loadItems:function(){var e=this,n=function(n){return e.items.splice(0,e.items.length),e._loadItemsFile().then(function(t){if(t&&t.items&&t.items.length){var o=[];return t.items.forEach(function(t){if(t){var i=e._wrap(t,n);e.items.push(i),o.push(i.status==r.downloading&&i.downloadid&&!i.download?e._swapTempFile(i).then(function(){return e._checkItem(i)}):e._checkItem(i))}}),WinJS.Promise.join(o).then(function(){e.items.length&&e.startLoop(),e.debouncedSave(),e.ready=!0})}e.ready=!0,e.debouncedSave()},function(n){o.error("error loading items",n),e.ready=!0})};return WinJSContrib.BgDownloads.initDownloads().then(function(e){return n(e)},function(e){return n([])}).then(function(){return e.checkDownloads()},function(e){return o.error("tracker error",e),WinJS.Promise.wrap()})},saveItems:function(e){var t=this;return t.saveItemsPromise.then(function(){var r=t.items.map(t._unwrap),i=t.defaultFolderPromise.then(function(e){return e.createFileAsync(n,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(e){return Windows.Storage.FileIO.writeTextAsync(e,JSON.stringify({items:r})).then(function(){o.verbose("items saved")})})}).then(null,function(n){return o.warn("error saving bgdownload tracker items",n),e=e||0,2>e?WinJS.Promise.timeout(20).then(function(){return t.saveItemsPromise=WinJS.Promise.wrap(),t.saveItems(e+1),t.saveItemsPromise}):void o.error("error saving bgdownload tracker items",n)});return i.then(function(){t.saveItemsPromise==i&&(o.verbose("refresh save promise"),t.saveItemsPromise=WinJS.Promise.wrap())}),t.saveItemsPromise=i,t.saveItemsPromise})},attach:function(e,n){var t=this;n.oncomplete=function(){e.download=null,e.status=r.downloaded,t._swapTempFile(e).then(function(){return t._checkItem(e)},function(e){return o.error("error swapping temp file",e),WinJS.Promise.wrap()}).then(function(){t.debouncedSave(),e.errorMessage?o.debug("bgdownload complete with errors",{data:e.data,message:e.errorMessage}):o.debug("bgdownload complete",{data:e.data,message:e.errorMessage}),t.debouncedCheck(),t.dispatchEvent("downloadcomplete",{data:e.data})},function(e){return o.error("error removing item",e),WinJS.Promise.wrap()})},n.onerror=function(n){e.status=r.error,e.download=null,e.downloadid=null,e.errorMessage=n.message;var i=WinJS.Promise.wrap();n.asyncOpType&&"Windows.Foundation.IAsyncOperationWithProgress`2<Windows.Networking.BackgroundTransfer.DownloadOperation,Windows.Networking.BackgroundTransfer.DownloadOperation>"==n.asyncOpType&&n.message&&n.message.indexOf("(404)")>0&&(e.status=r.downloaded,o.warn("remote item not found, skipping item "+e.itemid),i=t._checkItem(e,!0)),i.then(function(){return t.removeFile(e)}).then(function(){e.filepath=null}).then(function(){t.debouncedSave(),t.debouncedCheck()},function(e){return o.error("error removing file on error",e),WinJS.Promise.wrap()}),n.item=e.data,o.debug("bgdownload error",{error:n,data:e.data}),t.dispatchEvent("downloaderror",{data:e.data,error:n})},n.onprogress=function(n){e.progress=n}},_wrap:function(e,n){var o=this,r=new t;if(r.data=e.data,r.itemid=e.itemid,r.folderpath=e.folderpath,r.uri=e.uri,r.filename=e.filename,r.filepath=e.filepath,r.status=e.status,r.downloadid=e.downloadid,r.downloadid&&n&&n.length){var n=n.filter(function(e){return e.download.guid==r.downloadid});n&&n.length&&(r.download=n[0],o.attach(r,n[0]))}return r},_checkItem:function(e,n){var t=this;return e.itemCheckPromise||(e.itemCheckPromise=WinJS.Promise.wrap()),e.itemCheckPromise.then(function(){var i=function(){if(e.status!=r.completed){if(e.status=r.downloaded,t.remove(e),t.handleItemProperties)return WinJS.Promise.as(t.handleItemProperties(e.data,file)).then(function(){e.status=r.completed},function(e){return o.error("error handling tracker items properties",e),WinJS.Promise.wrap()});e.status=r.completed}};return e.status===r.downloading&&e.downloadid||e.status===r.waiting?WinJS.Promise.wrap():e.status===r.error?WinJS.Promise.wrap():(e.itemCheckPromise=Windows.Storage.StorageFile.getFileFromPathAsync(e.filepath).then(function(e){return e?i():void 0},function(t){return n?i():(e.status=r.error,WinJS.Promise.wrap())}),e.itemCheckPromise)})},_swapTempFile:function(e){var n=".download";return e.filepath.indexOf(n)>0?Windows.Storage.StorageFile.getFileFromPathAsync(e.filepath).then(function(n){return n?n.renameAsync(e.filename,Windows.Storage.NameCollisionOption.replaceExisting).then(function(t){e.status=r.downloaded,e.filepath=n.path}):void 0},function(n){return o.error("internal error swapping temp file",n),e.status=r.error,WinJS.Promise.wrap()}):(o.error("invalid temp file"),e.status=r.error,WinJS.Promise.wrap())},_unwrap:function(e){var n={itemid:e.itemid,data:e.data,uri:e.uri,folderpath:e.folderpath,filename:e.filename,filepath:e.filepath,downloadid:e.downloadid,status:e.status};return n},add:function(e,n,o,i,a){var s=this,d=s.items.filter(function(e){return e.itemid==n});if(!d||!d.length){var l=new t;return l.itemid=n,l.data=e,l.folderpath=o,l.filename=i,l.uri=a,l.status=r.waiting,s.items.push(l),s.debouncedCheck(),s.debouncedSave(),WinJS.Promise.wrap()}},startDownloads:function(e){var n=this;return e.forEach(function(e){e.status=r.downloading}),n.downloadsStart.then(function(){var t=[];e.forEach(function(e){var i=null;if(e){i=e.folderpath?Windows.Storage.StorageFolder.getFolderFromPathAsync(e.folderpath):n.defaultFolderPromise;var a=i.then(function(t){if(WinJSContrib.BgDownloads.currentDownloads.length>n.maxConcurrentDownloads)return e.status=r.waiting,o.debug("too much pendings dl "+WinJSContrib.BgDownloads.currentDownloads.length+" / "+n.maxConcurrentDownloads+" "+n.items.length),WinJS.Promise.wrap();var i=new WinJSContrib.BgDownloads.Download,a=encodeURIComponent(e.filename),s=new Windows.Foundation.Uri(e.uri),d=i.start(s,a+".download",t,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(t){o.debug("bgdownload start "+WinJSContrib.BgDownloads.currentDownloads.length+" / "+n.maxConcurrentDownloads+" "+n.items.length),e.status=r.downloading,e.download=t,e.downloadid=t.download.guid,e.filepath=t.file,n.attach(e,t)}).then(null,function(n){o.error("download start error "+n),e.status=r.error,e.download=null,e.downloadid=null});return d});t.push(a)}});var i=WinJS.Promise.join(t);return i=i.then(function(e){return e},function(e){return o.error("error starting dowloads",e),WinJS.Promise.wrap()}),n.downloadsStart=i,i.then(function(){return n.downloadsStart==i&&(o.verbose("refresh start downloads promise"),n.downloadsStart=WinJS.Promise.wrap()),n.debouncedSave()},function(e){o.warn("error saving bgdownload items ",e)}),n.downloadsStart})},checkDownloads:function(){var e=this;return e.startLoop(),WinJSContrib.BgDownloads.currentDownloads.length>e.maxConcurrentDownloads?(o.debug("checking download, too much pendings "+WinJSContrib.BgDownloads.currentDownloads.length+" / "+e.maxConcurrentDownloads+" "+e.items.length),WinJS.Promise.wrap()):e.downloadsStart.then(function(){var n=e.checkState();if(o.debug("checking download "+n.length+" files to download "+WinJSContrib.BgDownloads.currentDownloads.length+" / "+e.maxConcurrentDownloads+" "+e.items.length),n.length){var t=WinJSContrib.BgDownloads.currentDownloads.length;if(WinJSContrib.BgDownloads.currentDownloads.length<e.maxConcurrentDownloads){var r=n.slice(0,e.maxConcurrentDownloads-t);return e.startDownloads(r)}}return WinJS.Promise.wrap()}).then(function(){e.checkState()})},checkState:function(){var e=this,n=e.items.filter(function(e){return e.status==r.waiting||e.status==r.error});return e.state.nbPendings=n.length+WinJSContrib.BgDownloads.currentDownloads.length,0===e.state.nbPendings&&e.debouncedVerif(),e.refreshInterval&&0==e.items.length&&0==WinJSContrib.BgDownloads.currentDownloads.length&&(clearInterval(e.refreshInterval),e.refreshInterval=null),n},removeFile:function(e){var n=this;console.log("remove item file for "+e.itemid);var t=n.items.indexOf(e);return t>=0?(console.log("remove item file for "+e.itemid+" "+e.filepath),Windows.Storage.StorageFile.getFileFromPathAsync(e.filepath).then(function(e){return e?e.deleteAsync():void 0},function(n){return console.info("file not found "+e.filepath,n),WinJS.Promise.wrap()})):WinJS.Promise.wrap()},remove:function(e){var n=this,t=n.items.indexOf(e);return t>=0?(console.log("remove item from list "+e.itemid),n.items.splice(t,1),Windows.Storage.StorageFile.getFileFromPathAsync(e.filepath).then(function(e){var n=".download";return e.path.indexOf(n)==e.path.length-n.length?e.deleteAsync():void 0},function(e){return console.info("file not found",e),WinJS.Promise.wrap()}).then(function(){n.debouncedSave()})):(console.warn("item "+e.itemid+" not found"),WinJS.Promise.wrap())},exists:function(e){var n=this,t=n.items.filter(function(n){return n.itemid==e});return t.length>0},get:function(e){var n=this,t=n.items.filter(function(n){return n.itemid==e});return t&&t.length?t[0]:null}}),WinJS.Utilities.eventMixin,WinJS.Utilities.createEventProperties(["downloadcomplete","downloaderror"]))}();