/* 
 * WinJS Contrib v2.1.0.4
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

var WinJSContrib=WinJSContrib||{};WinJSContrib.BgDownloads=WinJSContrib.BgDownloads||{},function(){"use strict";var t=Windows.Storage.ApplicationData.current.localFolder,e="downloadeditems.json",n=WinJS.Binding.define({download:null,status:null,progress:0});WinJSContrib.BgDownloads.Tracker=WinJS.Class.mix(WinJS.Class.define(function(t,e){var n=this;n.name=t,e=e||{},this.folder=e.folder,this.handleItemProperties=e.handleItemProperties,e.getFolder&&(this.getFolder=e.getFolder),e.createFolder&&(this.createFolder=e.createFolder),this.items=new WinJS.Binding.List,n.ready=!1},{_getFolder:function(t){return this.folder?WinJS.Promise.wrap(this.folder):t?this.createFolder():this.getFolder()},getFolder:function(){return t.getFolderAsync("downloads\\"+this.name,Windows.Storage.CreationCollisionOption.openIfExists)},createFolder:function(e){return t.createFolderAsync("downloads\\"+this.name,Windows.Storage.CreationCollisionOption.openIfExists)},_loadItemsFile:function(){var t=this;return t._getFolder(!1).then(function(t){return t?t.getFileAsync(e).then(function(t){return Windows.Storage.FileIO.readTextAsync(t).then(function(t){var e=t?JSON.parse(t):{};return e})},function(){return[]}):void 0})},loadItems:function(){var t=this,e=function(e){return t.items.splice(0,t.items.length),t._loadItemsFile().then(function(n){n&&n.items&&n.items.length&&n.items.forEach(function(n){if(n){var i=t._wrap(n,e);t.items.push(i)}}),t.ready=!0,t.saveItems()},function(){t.ready=!0})};return WinJSContrib.BgDownloads.initDownloads().then(function(t){return e(t)},function(t){return e([])})},saveItems:function(){var t=this,n=t.items.map(t._unwrap);return t._getFolder(!0).then(function(t){return t.createFileAsync(e,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(t){return Windows.Storage.FileIO.writeTextAsync(t,JSON.stringify({items:n}))})})},attach:function(t,e){var n=this;e.oncomplete=function(){t.download=null,n._checkItem(t).then(function(){n.saveItems()}),n.dispatchEvent("downloadcomplete",{data:t.data})},e.onerror=function(e){t.status="error",t.download=null,n.saveItems(),e.item=t.data,n.dispatchEvent("downloaderror",e)},e.onprogress=function(e){t.progress=e}},_wrap:function(t,e){var i=this,o=new n;if(o.data=t.data,o.itemid=t.itemid,o.filename=t.filename,o.filepath=t.filepath,o.status=t.status,o.downloadid=t.downloadid,o.downloadid&&e&&e.length){var e=e.filter(function(t){return t.download.guid==o.downloadid});e&&e.length&&(o.download=e[0],i.attach(o,e[0]))}else i._checkItem(o);return o},_checkItem:function(t){var e=this;return Windows.Storage.StorageFile.getFileFromPathAsync(t.filepath).then(function(n){if(n&&"ready"!=t.status){if(t.status="downloaded",e.handleItemProperties)return WinJS.Promise.as(e.handleItemProperties(t.data,n)).then(function(){t.status="ready"},function(){});t.status="ready"}},function(){t.status="unavailable"})},_unwrap:function(t){var e={itemid:t.itemid,data:t.data,filename:t.filename,filepath:t.filepath,downloadid:t.downloadid,status:t.status};return e},add:function(t,e,i,o){var r=this,i=encodeURIComponent(i);return r._getFolder(!0).then(function(a){var s=new WinJSContrib.BgDownloads.Download;return s.start(o,i,a,Windows.Storage.CreationCollisionOption.replaceExisting).then(function(o){var a=new n;return a.itemid=e,a.data=t,a.downloadid=o.download.guid,a.download=o,a.filename=i,a.filepath=o.file,a.status="downloading",r.attach(a,o),r.items.push(a),r.saveItems()})})},remove:function(t){var e=this;console.log("remove item "+t.itemid);var n=e.items.indexOf(t);return n>=0?Windows.Storage.StorageFile.getFileFromPathAsync(t.filepath).then(function(t){return t.deleteAsync()},function(t){console.error("file not found"),console.error(t)}).then(function(){return e.items.splice(n,1),e.saveItems()}):WinJS.Promise.wrap()},exists:function(t){var e=this,n=e.items.filter(function(e){return e.itemid==t});return n.length>0},get:function(t){var e=this,n=e.items.filter(function(e){return e.itemid==t});return n&&n.length?n[0]:null}}),WinJS.Utilities.eventMixin,WinJS.Utilities.createEventProperties(["downloadcomplete","downloaderror"]))}();