/* 
 * WinJS Contrib v2.1.0.4
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

var WinJSContrib=WinJSContrib||{};!function(){function o(){return new WinJS.Promise(function(o,n){Windows.Networking.BackgroundTransfer.BackgroundDownloader.getCurrentDownloadsAsync().then(function(n){for(var e=new WinJS.Binding.List,a=0;a<n.size;a++){var i=new WinJSContrib.BgDownloads.Download;i.load(n[a]),e.push(i)}r.info(e.length+" pending downloads"),WinJSContrib.BgDownloads.currentDownloads=e,WinJS.Application.queueEvent({type:"mcnbgdownload.init",downloads:e}),o(e)},function(n){var r=new WinJS.Binding.List;WinJSContrib.BgDownloads.currentDownloads=r,o(r)})})}function n(){return new WinJS.Promise(function(o,n){Windows.Networking.BackgroundTransfer.BackgroundUploader.getCurrentUploadsAsync().then(function(n){for(var e=new WinJS.Binding.List,a=0;a<n.size;a++){var i=new WinJSContrib.BgDownloads.Upload;i.load(n[a]),e.push(i)}r.info(e.length+" pending uploads"),WinJSContrib.BgDownloads.currentUploads=e,WinJS.Application.queueEvent({type:"mcnbgupload.init",uploads:e}),o(e)},function(n){var r=new WinJS.Binding.List;WinJSContrib.BgDownloads.currentUploads=r,o(r)})})}var r=WinJSContrib.Logs.getLogger("WinJSContrib.BgDownload");WinJSContrib.BgDownloads=WinJSContrib.BgDownloads||{},WinJSContrib.BgDownloads.currentDownloads=new WinJS.Binding.List,WinJSContrib.BgDownloads.currentUploads=new WinJS.Binding.List,WinJSContrib.BgDownloads.initDownloads=o,WinJSContrib.BgDownloads.initUploads=n,WinJSContrib.BgDownloads.init=function(){return WinJS.Promise.join([o(),n()])},WinJSContrib.BgDownloads.Download=WinJS.Class.mix(WinJS.Class.define(function(){this._initObservable(),this.progress=0,this.download=null,this.promise=null,this.imageStream=null,this.oncomplete=null,this.onerror=null,this._completeCallbackBinded=this._completeCallback.bind(this),this._progressCallbackBinded=this._progressCallback.bind(this),this._errorCallbackBinded=this._errorCallback.bind(this)},{start:function(o,n,e,a,i,d){var l=this;return"string"==typeof o&&(o=new Windows.Foundation.Uri(o)),e=e||Windows.Storage.ApplicationData.current.localFolder,i=i||Windows.Networking.BackgroundTransfer.BackgroundTransferPriority["default"],a=a||Windows.Storage.CreationCollisionOption.failIfExists,new WinJS.Promise(function(t,s){var u=function(o){l._errorCallback(o),s(o)};e.createFileAsync(n,a).then(function(n){var e=new Windows.Networking.BackgroundTransfer.BackgroundDownloader;return r.verbose("bg download using URI: "+o.absoluteUri),l.download=e.createDownload(o,n),l.download.priority=i,WinJSContrib.BgDownloads.currentDownloads.push(l),l.file=l.download.resultFile.path,l.progress=0,d?Windows.Networking.BackgroundTransfer.BackgroundDownloader.requestUnconstrainedDownloadsAsync([l.download]).then(function(o){r.verbose("Request for unconstrained downloads has been "+(o.isUnconstrained?"granted":"denied")),l.promise=l.download.startAsync().then(l._completeCallbackBinded,l._errorCallbackBinded,l._progressCallbackBinded),t(l)},u):(l.promise=l.download.startAsync().then(l._completeCallbackBinded,l._errorCallbackBinded,l._progressCallbackBinded),void t(l))},u)})},load:function(o){var n=this;n.download=o,r.debug("Found download: "+n.download.guid+" from previous application run."),n.promise=n.download.attachAsync().then(n._completeCallbackBinded,n._errorCallbackBinded,n._progressCallbackBinded),n.file=n.download.resultFile.path,n.progress=0},cancel:function(){var o=this;o.promise?(o.promise.cancel(),o.promise=null,r.verbose("Canceling download: "+o.download.guid)):r.verbose("Download "+o.download.guid+" already canceled.")},resume:function(){var o=this;o.download&&(download.progress.status===Windows.Networking.BackgroundTransfer.BackgroundTransferStatus.pausedByApplication?(o.download.resume(),r.debug("Resuming download: "+o.download.guid)):r.debug("Download "+o.download.guid+" is not paused, it may be running, completed, canceled or in error."))},pause:function(){var o=this;o.download&&(o.download.progress.status===Windows.Networking.BackgroundTransfer.BackgroundTransferStatus.running?(o.download.pause(),r.debug("Pausing download: "+o.download.guid)):r.debug("Download "+o.download.guid+" is not running, it may be paused, completed, canceled or in error."))},hasGuid:function(o){var n=this;return n.download.guid===o},removeDownload:function(o){WinJSContrib.BgDownloads.currentDownloads&&WinJSContrib.BgDownloads.currentDownloads.forEach(function(n,r){n.hasGuid(o)&&WinJSContrib.BgDownloads.currentDownloads.splice(r,1)})},_progressCallback:function(o){var n=this;n.progress=100*n.download.progress.bytesReceived/n.download.progress.totalBytesToReceive<<0,n.onprogress&&n.onprogress(n.progress)},_completeCallback:function(){var o=this;if(o.ended=!0,o.download&&o.download.progress.status===Windows.Networking.BackgroundTransfer.BackgroundTransferStatus.completed?(WinJS.Application.queueEvent({type:"mcnbgdownload.success",uploadId:o.download.guid,operation:o}),o.oncomplete?(o.oncomplete(),o.oncomplete=null,o.onerror=null):o.notify("complete")):(o.download&&WinJS.Application.queueEvent({type:"mcnbgdownload.error",uploadId:o.download.guid,operation:o}),o._errorCallback("transfert problem")),o.download){try{var n=o.download.getResponseInformation();r.verbose(o.download.guid+" - download complete. Status code: "+n.statusCode),WinJS.Application.queueEvent({type:"McnBgDownload",error:!1,id:o.download.guid,operation:o})}catch(e){r.error(e)}o.removeDownload(o.download.guid)}},_errorCallback:function(o){var n=this;n.ended=!0,n.error=o,n.download&&(WinJS.Application.queueEvent({type:"mcnbgdownload.error",uploadId:n.download.guid,operation:n}),n.download.resultFile.deleteAsync().done(function(){},function(){}),n.removeDownload(n.download.guid),WinJS.Application.queueEvent({type:"McnBgDownload",error:!0,id:n.download.guid,operation:n}),r.warn(n.download.guid+" - download completed with error.")),n.onerror?(n.onerror(o),n.onerror=null):n.notify("error"),r.warn(o)}}),WinJS.Binding.mixin,WinJS.Binding.expandProperties({progress:0})),WinJSContrib.BgDownloads.Download.run=function(o,n,r,e,a,i){var d=null;return WinJSContrib.BgDownloads.currentDownloads.forEach(function(n){n.download.requestedUri.toString()==o.toString()&&(d=n)}),d?WinJS.Promise.wrap(d):(d=new WinJSContrib.BgDownloads.Download,d.start(o,n,r,e,a,i).then(function(){return d}))},WinJSContrib.BgDownloads.Upload=WinJS.Class.mix(WinJS.Class.define(function(){this._initObservable(),this.progress=0,this.download=null,this.promise=null,this.imageStream=null,this.oncomplete=null,this.onerror=null,this._completeCallbackBinded=this._completeCallback.bind(this),this._progressCallbackBinded=this._progressCallback.bind(this),this._errorCallbackBinded=this._errorCallback.bind(this)},{start:function(o,n,e,a){var i=this;return e=e||Windows.Networking.BackgroundTransfer.BackgroundTransferPriority["default"],new WinJS.Promise(function(d,l){var t=function(o){i._errorCallback(o),l(o)},s=new Windows.Networking.BackgroundTransfer.BackgroundUploader;return r.verbose("bg upload using URI: "+o.absoluteUri),i.upload=s.createUpload(o,n),i.upload.priority=e,WinJSContrib.BgDownloads.currentUploads.push(i),i.file=i.upload.sourceFile.path,i.progress=0,a?Windows.Networking.BackgroundTransfer.BackgroundUploader.requestUnconstrainedUploadsAsync([i.upload]).then(function(o){r.verbose("Request for unconstrained uploads has been "+(o.isUnconstrained?"granted":"denied")),i.promise=i.upload.startAsync().then(i._completeCallbackBinded,i._errorCallbackBinded,i._progressCallbackBinded),d(i)},t):(i.promise=i.upload.startAsync().then(i._completeCallbackBinded,i._errorCallbackBinded,i._progressCallbackBinded),void d(i))})},load:function(o){var n=this;n.upload=o,r.debug("Found upload: "+n.upload.guid+" from previous application run."),n.promise=n.upload.attachAsync().then(n._completeCallbackBinded,n._errorCallbackBinded,n._progressCallbackBinded),n.file=n.upload.sourceFile.path,n.progress=0},cancel:function(){var o=this;o.promise?(o.promise.cancel(),o.promise=null,r.debug("Canceling upload: "+o.upload.guid)):r.debug("upload "+o.upload.guid+" already canceled.")},resume:function(){var o=this;o.upload&&(o.upload.progress.status===Windows.Networking.BackgroundTransfer.BackgroundTransferStatus.pausedByApplication?(o.upload.resume(),r.debug("Resuming upload: "+o.upload.guid)):r.debug("upload "+o.upload.guid+" is not paused, it may be running, completed, canceled or in error."))},pause:function(){var o=this;o.upload&&(o.upload.progress.status===Windows.Networking.BackgroundTransfer.BackgroundTransferStatus.running?(o.upload.pause(),r.debug("Pausing upload: "+o.upload.guid)):r.debug("upload "+o.upload.guid+" is not running, it may be paused, completed, canceled or in error."))},hasGuid:function(o){var n=this;return n.upload.guid===o},removeUpload:function(o){WinJSContrib.BgDownloads.currentUploads&&WinJSContrib.BgDownloads.currentUploads.forEach(function(n,r){n.hasGuid(o)&&WinJSContrib.BgDownloads.currentUploads.splice(r,1)})},_progressCallback:function(o){var n=this;n.progress=100*n.upload.progress.bytesSended/n.upload.progress.totalBytesToSend<<0},_completeCallback:function(){var o=this;if(o.ended=!0,o.upload&&o.upload.progress.status===Windows.Networking.BackgroundTransfer.BackgroundTransferStatus.completed?(WinJS.Application.queueEvent({type:"mcnbgupload.success",uploadId:o.upload.guid,file:o.upload.sourceFile.path,operation:o}),o.oncomplete?(o.oncomplete(),o.oncomplete=null,o.onerror=null):o.notify("complete")):(o.upload&&WinJS.Application.queueEvent({type:"mcnbgupload.error",uploadId:o.upload.guid,file:o.upload.sourceFile.path,uri:o.upload.requestedUri,operation:o}),o._errorCallback("transfert problem")),o.upload){try{var n=o.upload.getResponseInformation();r.verbose(o.upload.guid+" - upload complete. Status code: "+n.statusCode)}catch(e){r.error(e)}o.removeUpload(o.upload.guid)}},_errorCallback:function(o){var n=this;n.ended=!0,n.error=o,n.upload&&(WinJS.Application.queueEvent({type:"mcnbgupload.error",uploadId:n.upload.guid,file:n.upload.sourceFile.path,uri:n.upload.requestedUri,operation:n}),n.removeUpload(n.upload.guid),r.warn(n.upload.guid+" - upload completed with error.")),n.onerror?(n.onerror(o),n.onerror=null):n.notify("error"),r.warn(o)}}),WinJS.Binding.mixin,WinJS.Binding.expandProperties({progress:0})),WinJSContrib.BgDownloads.Upload.run=function(o,n,r,e){var a=null;return WinJSContrib.BgDownloads.currentUploads.forEach(function(n){n.upload.requestedUri.toString()==o.toString()&&(a=n)}),a?WinJS.Promise.wrap(a):(a=new WinJSContrib.BgDownloads.Upload,a.start(o,n,r,e).then(function(){return a}))}}();