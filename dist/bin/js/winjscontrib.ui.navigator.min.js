/* 
 * WinJS Contrib v2.1.0.0
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

!function(){"use strict";var t=null;window.Windows&&window.Windows.UI&&window.Windows.UI.ViewManagement&&window.Windows.UI.ViewManagement.ApplicationView&&(t=window.Windows.UI.ViewManagement.ApplicationView);var i=WinJS.Navigation,e=function(t){return WinJS.UI.Animation.exitPage(t)},n=function(t){return WinJS.UI.Animation.enterPage(t)};WinJS.Namespace.define("WinJSContrib.UI",{parentNavigator:function(t){for(var i=t.parentNode;i;){if(i.mcnNavigator)return i.winControl;i=i.parentNode}},PageControlNavigator:WinJS.Class.mix(WinJS.Class.define(function(a,o){var o=o||{},s=this;this.element=a||document.createElement("div"),this.element.winControl=this,this.element.mcnNavigator=!0,this.element.classList.add("mcn-navigator"),this.element.classList.add("mcn-navigation-ctrl"),this.eventTracker=new WinJSContrib.UI.EventTracker,this.delay=o.delay||0,this.disableHistory=o.disableHistory||!1,this.animationWaitForPreviousPageClose=o.animationWaitForPreviousPageClose||!0,this.animations={},this.locks=0,o.enterPageAnimation&&(this.animations.enterPage=WinJSContrib.Utils.resolveMethod(a,o.enterPageAnimation)),this.animations.enterPage||(this.animations.enterPage=n),o.exitPageAnimation&&(this.animations.exitPage=WinJSContrib.Utils.resolveMethod(a,o.exitPageAnimation)),this.animations.exitPage||(this.animations.exitPage=e),this.home=o.home,t&&(this._lastViewstate=t.value),this.global=void 0!==o.global?o.global:!0,this.global?(document.body.onkeyup=this._keyupHandler.bind(this),document.body.onkeypress=this._keypressHandler.bind(this),document.body.onmspointerup=this._mspointerupHandler.bind(this),WinJSContrib.UI.Application=WinJSContrib.UI.Application||{},WinJSContrib.UI.Application.navigator=this,this.eventTracker.addEvent(i,"beforenavigate",this._beforeNavigate.bind(this)),this.eventTracker.addEvent(i,"navigated",this._navigated.bind(this))):(o.navigationEvents&&this.addNavigationEvents(),this._history={backstack:[]}),this.eventTracker.addEvent(window,"resize",function(t){s.resizeHandler&&cancelAnimationFrame(s.resizeHandler),s.resizeHandler=requestAnimationFrame(function(){s.resizeHandler=null,s._resized(t)})})},{home:"",element:null,_lastNavigationPromise:WinJS.Promise.as(),_lastViewstate:0,pageControl:{get:function(){return this.pageElement?this.pageElement.winControl:null}},pageElement:{get:function(){return this._pageElement||this.element.lastElementChild}},history:{get:function(){return this.global?WinJS.Navigation.history:this._history}},addLock:function(){this.locks++},removeLock:function(){this.locks--},_createPageElement:function(){var t=document.createElement("div");return t.setAttribute("dir",window.getComputedStyle(this.element,null).direction),t},dispose:function(){this._disposed||(this._disposed=!0,this.removeNavigationEvents(),WinJS.Utilities.disposeSubTree&&WinJS.Utilities.disposeSubTree(this.element),this.eventTracker.dispose())},_checkBackNavigation:function(t){var i=this,e=i.pageControl,n=function(){t.handled=!0,t.preventDefault&&t.preventDefault()},a=function(){return i.canGoBack?(i.back(),n(),!0):void 0};if(!e.canClose)return a();var o=e.canClose();return WinJS.Promise.is(o)?void o.then(function(t){return t?a():(n(),!0)}):o?a():(n(),!0)},addNavigationEvents:function(){var t=this;this.navigationEvents=WinJSContrib.UI.registerNavigationEvents(this,function(i){t._checkBackNavigation(i)})},removeNavigationEvents:function(){this.navigationEvents&&(this.navigationEvents(),this.navigationEvents=null)},_getAnimationElements:function(t){return this.pageControl&&this.pageControl.getAnimationElements?this.pageControl.getAnimationElements(t):this.pageElement},_keypressHandler:function(t){this.locks>0||"Backspace"===t.key&&this.back()},_keyupHandler:function(t){this.locks>0||("Left"===t.key&&t.altKey||"BrowserBack"===t.key)&&this.back()},_mspointerupHandler:function(t){3===t.button?i.back():4===t.button&&i.forward()},navigate:function(t,i,e,n){var a=this;if(this.global)return WinJS.Navigation.navigate(t,i);var o={skipHistory:e,detail:{location:t,state:i,setPromise:function(t){this.pagePromise=t}}};return a._beforeNavigate(o),o.detail.pagePromise=o.detail.pagePromise||WinJS.Promise.wrap(),a._history.current={state:i,location:t},o.detail.pagePromise.then(function(){return n&&a._history.backstack.splice(a._history.backstack.length-1,1),a._navigated(o),o.detail.pagePromise})},clearHistory:function(){this.global?WinJS.Navigation.history.backStack=[]:(this._history.backstack=[],this._history.current=null)},closeAllPages:function(){for(var t=this,i=t.element.querySelectorAll(".pagecontrol"),e=0,n=i.length;n>e;e++){var a=i[e];a.parentElement==t.element&&(a.winControl.dispose(),t.element.removeChild(a))}},clear:function(){this.clearHistory(),this.closeAllPages(),this._pageElement=null,this.element.innerHTML=""},open:function(t,i){return this.navigate(t,i)},pick:function(t,i){return i=i||{},i.navigateStacked=!0,this.navigate(t,i)},canGoBack:{get:function(){return this.global?i.canGoBack:this._history.backstack.length>0}},back:function(t){var i=this;if(i.global)return WinJS.Navigation.back(t);if(i._history.backstack.length){var e=i._history.backstack.length-1,n=i._history.backstack[e];return i.navigate(n.location,n.state,!0,!0)}},_beforeNavigate:function(t){var i=this,e=this.pageElement;t.detail.state=t.detail.state||{};var n=1==i.stackNavigation||t.detail.state.navigateStacked;if(this.locks>0){var a=new WinJS.Promise(function(){});return t.detail.setPromise(a),void a.cancel()}if(e&&e.winControl&&e.winControl.canClose){var o=null,a=new WinJS.Promise(function(t){o=t});return setImmediate(function(){WinJS.Promise.wrap(e.winControl.canClose()).then(function(t){t?(i.triggerPageExit(),o()):a.cancel()})}),void t.detail.setPromise(a)}(!n||t.detail.state.mcnNavigationDetails)&&i.triggerPageExit()},triggerPageExit:function(){var t=this,i=this.pageElement,e=function(){i.style.display="none",i.style.visibility="hidden",i.style.opacity=""};if(i&&i.winControl&&!i.winControl.exitPagePromise){if(i.winControl.exitPage){var n=i.winControl.exitPage();if(n){var a=WinJS.Promise.as(n);i.winControl.exitPagePromise=a.then(function(){return i.winControl.exitPageAnimation?WinJS.Promise.as(i.winControl.exitPageAnimation()):void 0}).then(e)}else i.winControl.exitPagePromise=i.winControl.exitPageAnimation?WinJS.Promise.as(i.winControl.exitPageAnimation()).then(e):WinJS.Promise.as(t.animations.exitPage(t._getAnimationElements(!0))).then(e)}else i.winControl.exitPagePromise=i.winControl.exitPageAnimation?WinJS.Promise.as(i.winControl.exitPageAnimation()).then(e):WinJS.Promise.as(t.animations.exitPage(t._getAnimationElements(!0))).then(e);var o=i.querySelectorAll(".mcn-layout-ctrl");if(o&&o.length)for(var s=0;s<o.length;s++){var r=o[s].winControl;r.exitPage&&r.exitPage()}WinJSContrib.UI.Application.progress&&WinJSContrib.UI.Application.progress.show()}},closePage:function(t,i){var e=this;i=i||{};var n=(e.element,t||this.pageElement);n&&WinJSContrib.UI.untapAll(n);var a=n&&n.winControl&&n.winControl.exitPagePromise?n.winControl.exitPagePromise:WinJS.Promise.wrap();return e.dispatchEvent("closingPage",{page:n}),n&&n.winControl&&(n.winControl.pageLifeCycle.stop(),n.winControl.dispatchEvent("closing",{youpla:"boom"}),n.winControl.cancelPromises&&n.winControl.cancelPromises()),!e.global&&!e.disableHistory&&n&&n.winControl&&n.winControl.navigationState&&!i.skipHistory&&e._history.backstack.push(n.winControl.navigationState),e._pageElement=null,a.then(function(){if(n){n.style.opacity="0",n.style.display="none",n.winControl&&(n.winControl.stackedOn=null,n.winControl.stackedBy=null,n.winControl.eventTracker&&n.winControl.eventTracker.dispose(),n.winControl.unload&&n.winControl.unload()),WinJS.Utilities.disposeSubTree&&WinJS.Utilities.disposeSubTree(n);try{n.parentElement.removeChild(n)}catch(t){console.log("cannot remove page, WTF ????????")}}})},_navigated:function(t){var i=this;t.detail.state=t.detail.state||{};var e=i.element,n=this.pageControl,a=this.pageElement,o=1==i.stackNavigation||t.detail.state&&t.detail.state.navigateStacked;if(this._lastNavigationPromise&&(this._lastNavigationPromise.cancel(),WinJSContrib.UI.Application.progress&&WinJSContrib.UI.Application.progress.hide()),n&&n.stackedOn&&t.detail.state.mcnNavigationDetails){var s=i.closePage(a,t);return this._lastNavigationPromise=s,t.detail.setPromise(s),void(WinJSContrib.UI.Application.progress&&WinJSContrib.UI.Application.progress.hide())}if(o){!i.global&&!i.disableHistory&&a&&a.winControl&&a.winControl.navigationState&&!t.skipHistory&&i._history.backstack.push(a.winControl.navigationState);var s=WinJS.Promise.wrap()}else var s=i.closePage(a,t);t.detail.state.mcnNavigationDetails={id:WinJSContrib.Utils.guid(),date:new Date};{var r;new WinJS.Promise(function(t){r=t})}i.currentPageDetails=t.detail;var l=WinJSContrib.UI.Pages.renderFragment(e,t.detail.location,t.detail.state,{enterPage:i.animations.enterPage,closeOldPagePromise:s.then(function(){},function(){}),oninit:function(t){if(t){var e=t.winControl;e.navigator=i,e.element.mcnPage=!0,o&&(e.stackedOn=n,n&&(n.stackedBy=e)),e.renderComplete=e.renderComplete.then(function(){r()})}},onrender:function(e){t.detail.state&&t.detail.state.clearNavigationHistory&&(i.global?WinJS.Navigation.history.backStack=[]:i._history.backstack=[]),i._updateBackButton(e)},onready:function(t){i.dispatchEvent("pageContentReady",{page:t.winControl}),WinJSContrib.UI.Application.progress&&WinJSContrib.UI.Application.progress.hide()}}).then(function(){i._lastNavigationPromise=void 0});this._lastNavigationPromise=l,t.detail.setPromise(WinJS.Promise.join([s,l]))},_resized:function(){var i=this;if(this.pageControl&&this.pageControl.element){var i=this,e=this.pageControl,n=e.element;cancelAnimationFrame(i.layoutProcess),i.layoutProcess=requestAnimationFrame(function(){var a=t?t.value:null;if(e.__checkLayout)e.__checkLayout(n,a,i._lastViewstate);else{e.updateLayout&&e.updateLayout.call(e,n,a,i._lastViewstate);var o=n.element.querySelectorAll(".mcn-layout-ctrl");if(o&&o.length)for(var s=0;s<o.length;s++){var r=o[s].winControl;r.updateLayout&&r.updateLayout(r.element,a,i._lastViewstate)}}})}this._lastViewstate=t?t.value:null},_handleBack:function(){i.back()},_updateBackButton:function(t){var e=this,n=t.querySelectorAll(".win-backbutton, .back-button, .win-navigation-backbutton");if(n&&n.length>0)for(var a=!1,o=0,s=n.length;s>o;o++){var r=n[o];e.canGoBack&&!a?(r.classList.remove("disabled"),r.disabled=!1):(r.classList.add("disabled"),r.disabled=!0),r.onclick=function(t){if(e.global)i.back();else{var n=WinJSContrib.UI.parentNavigator(t.currentTarget);n.back()}}}}}),WinJS.Utilities.eventMixin)}),WinJSContrib.UI.WebComponents&&WinJSContrib.UI.WebComponents.register("mcn-navigator",WinJSContrib.UI.PageControlNavigator,{properties:["global"],map:{ENTERPAGEANIMATION:{attribute:"enterPageAnimation",property:"animations.enterPage",resolve:!0},EXITPAGEANIMATION:{attribute:"exitPageAnimation",property:"animations.exitPage",resolve:!0}}})}();