/* 
 * WinJS Contrib v2.1.0.6
 * licensed under MIT license (see http://opensource.org/licenses/MIT)
 * sources available at https://github.com/gleborgne/winjscontrib
 */

var WinJSContrib=WinJSContrib||{};!function(){function Messenger(e,n){var r=this;r.isWorker=void 0===e.document,r._pendings={},r._receiver=e,r._sender=n||e,r._bindedProcessEvent=r._processEvent.bind(r),r._receiver&&r._receiver.addEventListener("message",r._bindedProcessEvent)}WinJSContrib.Messenger=WinJS.Class.mix(Messenger,WinJS.Utilities.eventMixin),WinJSContrib.Messenger.SmartWorkerPath="/scripts/winjscontrib/winjscontrib.messenger.worker.js",WinJSContrib.Messenger.SmartWorker=function(e){if(window.Worker){var n=new window.Worker(e||WinJSContrib.Messenger.SmartWorkerPath);return new WinJSContrib.Messenger(n,n)}return new WinJSContrib.Messenger(null,null)},WinJSContrib.Messenger.prototype._send=function(e){this.isWorker?this._sender.postMessage(JSON.stringify(e)):this._sender.postMessage(JSON.stringify(e),"*")},WinJSContrib.Messenger.prototype.importScripts=function(e){return this._receiver?this.start("_doImportScripts",e):WinJS.Promise.wrap()},WinJSContrib.Messenger.prototype._doImportScripts=function(e){return new WinJS.Promise(function(n){if("string"==typeof e)importScripts(e);else if(e.length)for(var r=0;r<e.length;r++)importScripts(e[r]);n()})},WinJSContrib.Messenger.prototype.execute=function(e){var n=this,r=[];if(arguments.length>1)for(var i=1;i<arguments.length;i++)r.push(arguments[i]);if(n._receiver){var t="var messengerFunction="+e;return this.start("_runFunction",{f:t,args:r})}return WinJS.Promise.timeout(0).then(function(){return e.apply(null,r)})},WinJSContrib.Messenger.prototype._runFunction=function(functionArgs){var messenger=this;return new WinJS.Promise(function(c,e){try{eval(functionArgs.f);var res=messengerFunction.apply(null,functionArgs.args);c(res)}catch(exception){e(exception)}})},WinJSContrib.Messenger.prototype.map=function(e,n){var r=this;n.forEach(function(n){r[n]=function(){var r=e[n];return r.apply(e,arguments)}})},WinJSContrib.Messenger.prototype.start=function(e,n,r){var i=this;if(!i._receiver)return WinJS.Promise.wrapError("worker not supported");var t={id:WinJSContrib.Utils.guid(),complete:null,error:null,progress:null,promise:null},s={name:e,id:t.id,type:"run",data:n,asArgs:r,sender:"WinJSContrib.WinJSContrib.Messenger"};t.promise=new WinJS.Promise(function(e,n,r){t.complete=e,t.error=n,t.progress=r},function(){console.warn("message canceled"),s.type="cancel",i._send(s)}),i._pendings[t.id]=t;var o=function(){delete i._pendings[t.id]};return t.promise.done(o,o),i._send(s),t.promise},WinJSContrib.Messenger.prototype._processEvent=function(e){var n=this,r="string"==typeof e.data?JSON.parse(e.data):e.data,i=r.name,t=r.data,s=r.asArgs;if(r.id){var o=n._pendings[r.id];if(o&&o[r.type])return void o[r.type](t);if("cancel"===r.type){var a=n._pendings[r.id];a&&(a.promise.cancel(),delete n._pendings[r.id])}else{if("run"===r.type&&i&&n[i]){try{var d=null;d=WinJS.Promise.as(s?n[i].apply(n[i],t):n[i](t)),n._pendings[r.id]={promise:d,details:r},d.then(function(e){n._send({name:i,id:r.id,type:"complete",sender:"WinJSContrib.WinJSContrib.Messenger",data:e})},function(e){n._send({name:i,id:r.id,type:"error",sender:"WinJSContrib.WinJSContrib.Messenger",data:e})},function(e){n._send({name:i,id:r.id,type:"progress",sender:"WinJSContrib.WinJSContrib.Messenger",data:e})}).then(function(){delete n._pendings[r.id]})}catch(p){delete n._pendings[r.id],n._send({name:i,id:r.id,type:"error",sender:"WinJSContrib.WinJSContrib.Messenger",data:{description:p.description,message:p.message,stack:p.stack}})}return}n._send({name:i,id:r.id,type:"error",sender:"WinJSContrib.WinJSContrib.Messenger",data:{message:"callback function not found"}})}}else{if(i&&n[i])return void n[i](t);n.dispatchEvent(i,t)}},WinJSContrib.Messenger.prototype.dispose=function(){var e=this;e._receiver&&(e._receiver.terminate&&e._receiver.terminate(),e._receiver.removeEventListener("message",e._bindedProcessEvent))}}();